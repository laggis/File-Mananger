<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PenguinHosting File Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-dark: #0a192f;
            --primary: #172a45;
            --primary-light: #303c55;
            --accent: #64ffda;
            --text: #8892b0;
            --text-light: #ccd6f6;
        }
        body {
            background: var(--primary-dark);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(23, 42, 69, 0.8);
            border: 1px solid rgba(100, 255, 218, 0.1);
        }
        .cyber-border {
            clip-path: polygon(0 10px, 10px 0, calc(100% - 10px) 0, 100% 10px, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
        }
        .selected {
            background: rgba(100, 255, 218, 0.1);
            border: 1px solid var(--accent);
        }
        .hover-glow:hover {
            box-shadow: 0 0 20px rgba(100, 255, 218, 0.3);
        }
        .text-accent {
            color: var(--accent);
        }
        .text-light {
            color: var(--text-light);
        }
        #contextMenu {
            position: fixed;
            z-index: 1000;
            background: rgba(23, 42, 69, 0.95);
            border: 1px solid var(--accent);
            border-radius: 4px;
            padding: 8px 0;
            min-width: 150px;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            color: var(--text-light);
            display: flex;
            align-items: center;
        }

        .context-menu-item:hover {
            background: rgba(100, 255, 218, 0.1);
        }
    </style>
</head>
<body class="min-h-screen">
    <nav class="glass-effect p-4 mb-6">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-2xl font-bold text-accent">
                <i class="fas fa-cube mr-2"></i>PenguinHosting File Manager
            </div>
            <div class="flex items-center space-x-4">
                {% if session.is_admin %}
                <a href="{{ url_for('admin') }}" class="text-accent hover:text-light">
                    <i class="fas fa-cog mr-1"></i>Admin
                </a>
                {% endif %}
                <a href="{{ url_for('profile') }}" class="text-accent hover:text-light">
                    <i class="fas fa-user-circle mr-1"></i>Profile
                </a>
                <a href="{{ url_for('logout') }}" class="text-accent hover:text-light">
                    <i class="fas fa-sign-out-alt mr-1"></i>Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="mb-6 p-3 rounded {% if category == 'error' %}bg-red-900{% else %}bg-green-900{% endif %} text-light">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if is_admin %}
        <div class="mb-6 flex space-x-4">
            <!-- Upload Form -->
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="flex-1">
                <div class="glass-effect p-4 rounded">
                    <div class="flex items-center space-x-4">
                        <input type="file" name="file" class="flex-1 p-2 bg-dark rounded text-light">
                        <button type="submit" class="bg-accent text-dark px-4 py-2 rounded hover:bg-accent/80">
                            <i class="fas fa-upload mr-2"></i>Upload
                        </button>
                    </div>
                </div>
            </form>

            <!-- Create Folder Form -->
            <form action="{{ url_for('create_folder') }}" method="post" class="flex-1">
                <div class="glass-effect p-4 rounded">
                    <div class="flex items-center space-x-4">
                        <input type="text" name="folder_name" placeholder="Folder name" class="flex-1 p-2 bg-dark rounded text-light">
                        <button type="submit" class="bg-accent text-dark px-4 py-2 rounded hover:bg-accent/80">
                            <i class="fas fa-folder-plus mr-2"></i>Create
                        </button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}

        <div class="glass-effect cyber-border p-6 mb-6">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-accent mr-4">Files</h1>
                    {% if parent %}
                    <a href="{{ url_for('index', subpath=parent) }}" class="text-accent hover:text-light">
                        <i class="fas fa-arrow-up mr-1"></i>Up
                    </a>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-4">
                    <button id="downloadSelected" class="px-4 py-2 bg-transparent border border-accent text-accent rounded hover-glow disabled:opacity-50" disabled>
                        <i class="fas fa-download mr-2"></i>Download Selected (<span id="selectedCount">0</span>)
                    </button>
                    <button onclick="document.getElementById('uploadForm').classList.toggle('hidden')" class="px-4 py-2 bg-transparent border border-accent text-accent rounded hover-glow">
                        <i class="fas fa-upload mr-2"></i>Upload
                    </button>
                    <button onclick="document.getElementById('newFolderForm').classList.toggle('hidden')" class="px-4 py-2 bg-transparent border border-accent text-accent rounded hover-glow">
                        <i class="fas fa-folder-plus mr-2"></i>New Folder
                    </button>
                </div>
            </div>

            <!-- Upload Form -->
            <form id="uploadForm" class="mb-6 hidden" onsubmit="return uploadFile(event)">
                <div class="flex space-x-4">
                    <input type="file" name="file" class="flex-grow p-2 rounded bg-transparent border border-accent text-light">
                    <button type="submit" class="px-4 py-2 bg-transparent border border-accent text-accent rounded hover-glow">
                        Upload
                    </button>
                </div>
            </form>

            <!-- New Folder Form -->
            <form id="newFolderForm" class="mb-6 hidden" onsubmit="return createFolder(event)">
                <div class="flex space-x-4">
                    <input type="text" name="folder_name" placeholder="Folder name" class="flex-grow p-2 rounded bg-transparent border border-accent text-light">
                    <button type="submit" class="px-4 py-2 bg-transparent border border-accent text-accent rounded hover-glow">
                        Create
                    </button>
                </div>
            </form>

            <!-- File List -->
            <div class="grid grid-cols-1 gap-4">
                {% for file in files %}
                <div class="file-item glass-effect p-4 rounded flex justify-between items-center {% if not file.is_directory %}cursor-pointer{% endif %}"
                    {% if not file.is_directory %}onclick="toggleSelect(this, event)"{% endif %}
                    data-path="{{ file.path }}"
                    data-is-dir="{{ file.is_directory|lower }}">
                    <div class="flex items-center space-x-4">
                        <i class="fas {% if file.is_directory %}fa-folder text-accent{% else %}fa-file text-light{% endif %}"></i>
                        <div class="flex-1">
                            {% if file.is_directory %}
                            <a href="{{ url_for('index', subpath=file.path) }}" class="text-light hover:text-accent block w-full">
                                {{ file.name }}
                            </a>
                            {% else %}
                            <span class="text-light">{{ file.name }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        {% if not file.is_directory %}
                        <span class="text-sm text-gray-400">{{ file.size|filesizeformat }}</span>
                        {% endif %}
                        {% if is_admin %}
                        <button onclick="deleteItem(event, '{{ file.path }}')" class="text-red-500 hover:text-red-400">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div id="contextMenu" style="display: none;">
        <div class="context-menu-item" onclick="downloadSelectedFiles()">
            <i class="fas fa-download mr-2"></i> Download as ZIP
        </div>
        <div class="context-menu-item" onclick="clearSelection()">
            <i class="fas fa-times mr-2"></i> Clear Selection
        </div>
    </div>

    <script>
        let selectedFiles = new Set();

        function redirectToLogin() {
            window.location.href = "{{ url_for('login') }}";
        }

        async function downloadFile(path) {
            try {
                const response = await fetch(`/download/${path}`, {
                    method: 'GET',
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = path.split('/').pop();
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else if (response.status === 401) {
                    redirectToLogin();
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Download failed');
                }
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading file');
            }
        }

        async function downloadSelectedFiles() {
            if (selectedFiles.size === 0) return;
            
            try {
                const filePaths = Array.from(selectedFiles);
                const response = await fetch('/download-multiple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify({ files: filePaths })
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        redirectToLogin();
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Download failed');
                }
                
                // Get the filename from the Content-Disposition header if possible
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = 'selected_files.zip';
                if (contentDisposition) {
                    const matches = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/.exec(contentDisposition);
                    if (matches != null && matches[1]) {
                        filename = matches[1].replace(/['"]/g, '');
                    }
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
                
                clearSelection();
            } catch (error) {
                console.error('Download error:', error);
                alert(error.message || 'Error downloading files');
            } finally {
                document.getElementById('contextMenu').style.display = 'none';
            }
        }

        function toggleSelect(element, event) {
            // Don't handle selection for directories
            if (element.dataset.isDir === 'true') return;
            
            event.preventDefault();
            event.stopPropagation();
            
            const path = element.dataset.path;
            if (event.ctrlKey || event.metaKey) {
                if (selectedFiles.has(path)) {
                    selectedFiles.delete(path);
                    element.classList.remove('selected');
                } else {
                    selectedFiles.add(path);
                    element.classList.add('selected');
                }
            } else {
                const wasSelected = selectedFiles.has(path);
                clearSelection();
                if (!wasSelected) {
                    selectedFiles.add(path);
                    element.classList.add('selected');
                }
            }
            updateDownloadButton();
        }

        function updateDownloadButton() {
            const btn = document.getElementById('downloadSelected');
            const count = document.getElementById('selectedCount');
            count.textContent = selectedFiles.size;
            btn.disabled = selectedFiles.size === 0;
        }

        document.getElementById('downloadSelected').addEventListener('click', function() {
            if (selectedFiles.size > 0) {
                downloadSelectedFiles();
            }
        });

        async function uploadFile(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (response.ok) {
                    location.reload();
                } else {
                    alert(result.error || 'Upload failed');
                }
            } catch (error) {
                alert('Error uploading file: ' + error);
            }
            return false;
        }

        async function createFolder(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            try {
                const response = await fetch('/create_folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        folder_name: formData.get('folder_name'),
                        path: window.location.pathname.substring(1)
                    })
                });
                const result = await response.json();
                if (response.ok) {
                    location.reload();
                } else {
                    alert(result.error || 'Failed to create folder');
                }
            } catch (error) {
                alert('Error creating folder: ' + error);
            }
            return false;
        }

        async function deleteItem(event, path) {
            event.stopPropagation();
            if (confirm('Are you sure you want to delete this item?')) {
                try {
                    const response = await fetch('/delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ path: path })
                    });
                    const result = await response.json();
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert(result.error || 'Delete failed');
                    }
                } catch (error) {
                    alert('Error deleting item: ' + error);
                }
            }
        }

        document.addEventListener('contextmenu', function(e) {
            const fileItem = e.target.closest('.file-item');
            if (fileItem && selectedFiles.size > 0) {
                e.preventDefault();
                const menu = document.getElementById('contextMenu');
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';

                // Adjust menu position if it goes off screen
                const menuRect = menu.getBoundingClientRect();
                const windowWidth = window.innerWidth;
                const windowHeight = window.innerHeight;

                if (menuRect.right > windowWidth) {
                    menu.style.left = (windowWidth - menuRect.width) + 'px';
                }
                if (menuRect.bottom > windowHeight) {
                    menu.style.top = (windowHeight - menuRect.height) + 'px';
                }
            }
        });

        // Hide context menu when clicking outside
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('contextMenu');
            if (!menu.contains(e.target)) {
                menu.style.display = 'none';
            }
        });

        function clearSelection() {
            selectedFiles.clear();
            document.querySelectorAll('.selected').forEach(el => {
                el.classList.remove('selected');
            });
            document.getElementById('contextMenu').style.display = 'none';
            updateDownloadButton();
        }

        // Add double-click event listener only to files
        document.querySelectorAll('.file-item[data-is-dir="false"]').forEach(item => {
            item.addEventListener('dblclick', (e) => {
                e.preventDefault();
                downloadFile(item.dataset.path);
            });
        });
    </script>
</body>
</html>
